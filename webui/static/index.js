const runPage=async()=>{const S=document.querySelector("form"),c=document.querySelector("#asrv"),n=document.querySelector("#gwid"),o=document.querySelector("#gwky"),y=document.querySelector("#startScan"),d=document.querySelector("#ssidList"),f=d.querySelector("label").cloneNode(!0),v=document.querySelector("#wlan"),m=document.querySelector("#sec"),i=document.querySelector("#key"),r=(e,t)=>{t?(e.parentElement.classList.add("invalid"),e.parentElement.querySelector(".error").innerText=t):e.parentElement.classList.remove("invalid")},q=async()=>{fetch("settings.cgi").then(e=>e.json()).then(e=>{console.log("settings",e),c.value=e.asrv,c.disabled=e.locked,n.value=e.gwid,n.disabled=e.locked,o.value=e.locked?"[...]"+e.gwkey:e.gwkey,o.disabled=e.locked})};let g=!1;const h=async e=>{if(e&&e.preventDefault(),g)return;g=!0,d.innerHTML=null;const t=y.querySelector("img").classList;t.add("spinning"),fetch("scan.cgi?scan=1").then(()=>{fetch("ssids.cgi").then(u=>u.json()).then(u=>{console.log("ssids",u),u.APS.sort((s,l)=>s.rssi<l.rssi).forEach(s=>{const l=f.cloneNode(!0);l.querySelector("input").value=s.name,l.querySelector("input").addEventListener("change",b=>{!b.target.checked||(v.value=s.type,m.value=s.sec,i.disabled=s.sec=="no",i.value=s.sec=="no"?"":i.value)}),l.querySelector("span").innerText=`${s.name} (${s.sec} security)`;let a=1;s.rssi>-30?a=4:s.rssi>-67?a=3:s.rssi>-70&&(a=2),l.querySelector("img").src=`images/bar-${a}.svg`,d.appendChild(l)}),t.remove("spinning"),g=!1})})};y.addEventListener("click",h),S.onsubmit=e=>{r(c),r(n),r(o),r(i);let t=!1;return c.disabled||c.value.match(/https?:\/\//)||(t=!0,r(c,"must start with http:// or https://")),n.disabled||(n.value.length<3||n.value.length>36?(t=!0,r(n,"minimum length: 3, maximum length: 36")):n.value.match(/^[a-z0-9](?:[-]?[a-z0-9]){2,}(@[a-z0-9](?:[-]?[a-z0-9]){2,})?$/)||(t=!0,r(n,"must only contain lowercase letters, numbers and dashes"))),o.disabled||o.value.length==0&&(t=!0,r(o,"must be set")),v.value&&m.value!=="no"&&i.value.length==0&&(t=!0,r(i,"must be set on network with "+m.value+" security")),!t};try{q(),h()}catch(e){alert(e)}};document.addEventListener("DOMContentLoaded",runPage);
